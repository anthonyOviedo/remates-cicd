services:
  report-viewer:
    build:
      context: .
      dockerfile: Dockerfile.report-viewer
    container_name: report-viewer
    ports:
      - "8080:8081"
    depends_on:
      - report-engine # This dependency assumes you will define 'python-app' below

  report-engine:
    build:
      context: .
      dockerfile: Dockerfile.report-engine
    container_name: report-engine
    ports:
      - "5001:5001"
    volumes:
      - ./config/back/data:/reportEngine/data # Maps local './data' to '/reportEngine/data' in the container

  grafana:
    build:
      context: .
      dockerfile: Dockerfile.grafana
    container_name: grafana
    volumes:
      - grafana-data:/var/lib/grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    depends_on:
      - prometheus

  prometheus:
    build:
      context: .
      dockerfile: Dockerfile.prometheus
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - prometheus-data:/prometheus
    restart: unless-stopped
    command: --config.file=/etc/prometheus/prometheus.yml

  nginx:
    image: nginx:latest
    container_name: nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./config/nginx/default.conf:/etc/nginx/conf.d/default.conf
      - ./certbot/www:/var/www/certbot
      - ./certbot/conf:/etc/letsencrypt
    depends_on:
      - report-viewer
      - report-engine
    restart: always

  # ollama:
  #   image: ollama/ollama:latest
  #   container_name: ollama-deepseek
  #   runtime: nvidia
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=all
  #   ports:
  #     - "11434:11434"
  #   volumes:
  #     - ollama-data:/root/.ollama

volumes: # Corrected indentation
  prometheus-data:
    driver: local
  grafana-data:
    driver: local
  # ollama-data:
  #   driver: local
